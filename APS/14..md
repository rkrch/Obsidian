18. Виртуальная память. Принципы функционирования и способы организации виртуальной памяти. TLB.

_----Виртуальная память----_

Концепция виртуальной памяти, под которой понимается автоматическое управление иерархической памятью, при котором программист имеет дело с единой памятью большой емкости и высокого быстродействия, решает проблему невозможности размещения в основной памяти, ввиду большого объема, данных, с которыми в данный момент работает программа. По своей сути виртуализация памяти представляет собой способ аппаратно-программной реализации концепции иерархической памяти.

Основная память представляет собой линейное пространство из адресов и является физическим пространством памяти. Если появляется задача, требующая более ячеек, то в рамках идеи виртуализации памяти предоставляется значительно большее адресное пространство, обычно равное общей емкости всех видов памяти и называемое виртуальным пространством.

Адреса виртуального пространства называют виртуальными, а адреса физического пространства — физическими.

_----Принцип функционирования виртуальной памяти----_

Программа использует виртуальные адреса, но поскольку для ее выполнения надо, чтобы обрабатываемые команды и данные находились в основной памяти, требуется, чтобы каждому виртуальному адресу соответствовал физический адрес. Таким образом, в процессе вычислений необходимо прежде всего переписать из ВЗУ в ОП ту часть информации, на которую указывает виртуальный адрес (отобразить виртуальное пространство на физическое), а затем преобразовать виртуальный адрес в физический.

![](file:///C:/Users/kravr/AppData/Local/Temp/msohtmlclip1/01/clip_image001.jpg)

_----Способы организации виртуальной памяти----_

Суть страничной организации виртуальной памяти заключается в следующем: все адресное пространство, включая ОП и ВЗУ, разделяется на одинаковые по размеру части (кратные степени двойки), называемые страничными кадрами, или фреймами (page frame). Выполняемые программы делятся на блоки такого же размера, т. е. постранично. Страницам виртуальной и физической памяти присваивают номера (адрес).

![](file:///C:/Users/kravr/AppData/Local/Temp/msohtmlclip1/01/clip_image003.jpg)

Для получения данных из памяти процессор посылает устройству управления памятью виртуальный адрес ячейки, состоящий из номера виртуальной страницы и смещения относительно ее начала, с целью преобразования его в физический адрес. Поскольку смещения в виртуальном и физическом адресах одинаковы, преобразованию подвергается лишь номер страницы.

Если система преобразования адресов обнаруживает, что необходимая физическая страница отсутствует в ОП (т.е. произошел промах или страничный сбой), то нужная страница считывается из внешней памяти в ОП. Преобразование осуществляется с помощью специальной страничной таблицы (СТ). При отсутствии нужной страницы в ОП преобразователь адресов вырабатывает признак страничного сбоя, по которому процессор приостанавливает вычисления, пока нужная страница не будет считана из вторичной памяти в ОП. Страничная таблица полностью описывает виртуальное пространство. Она определяет, какие виртуальные страницы находятся в ОП и в каких физических кадрах.

_----Сегментно-страничная организация памяти----_

При страничной организации предполагается, что виртуальная память — это непрерывный массив со сквозной нумерацией слов, что не всегда можно признать наилучшим решением. Обычно программа состоит из нескольких частей — кодовой, информационной и стековой. Так как заранее неизвестны длины этих составляющих, то удобно, чтобы при программировании каждая из них имела собственную нумерацию слов, отсчитываемую с нуля. Для этого организуют систему сегментированной памяти, выделяя в виртуальном пространстве независимые линейные пространства переменной длины, называемые _сегментами_. Каждый сегмент представляет собой отдельную логическую единицу информации, содержащую совокупность данных или программный код и расположенную в адресном пространстве пользователя. В каждом сегменте устанавливается собственная нумерация слов, начиная с нуля. Виртуальная память также разбивается на сегменты с независимой адресацией слов внутри них. Каждой составляющей программы выделяется сегмент памяти. Виртуальный адрес определяется номером сегмента и адресом внутри сегмента. Для преобразования виртуального адреса в физический используется специальная сегментная таблица. Недостатком такого подхода является то, что неодинаковый размер сегментов приводит к неэффективному использованию ОП. Так, если ОП заполнена, то при замещении одного из сегментов требуется вытеснить другой, размер которого равен или больше размера нового. При многократном повторе подобных действий в ОП остается множество свободных участков, недостаточных по размеру для загрузки полного сегмента. Решением проблемы служит сегментно-страничная организация памяти. В ней размер сегмента выбирается не произвольно, а задается кратным размеру страницы. Сегмент может содержать то или иное, но обязательно целое число страниц, даже если одна из страниц заполнена частично. Возникает определенная иерархия в организации доступа к данным, состоящая из трех ступеней: сегмент → страница → слово

_----TLB----_

При большой СТ ее приходится хранить вместо специально выделенных для этого регистров в ОП, где доступ к ней по времени увеличивается в 2 раза.

Этого избегают с помощью добавления в состав вычислительной системы специального быстродействующего запоминающего устройства, называемого буфером быстрого преобразования адресов (Translation Lookaside Buffer — TLB), или буфером опережающей выборки, представляющего собой кэш-память. При каждом преобразовании номера виртуальной страницы в номер физической страницы результат заносится в TLB: номер физической страницы — в память данных, а виртуальной — в память тегов. Таким образом, в TLB попадают результаты нескольких последних операций трансляции адресов.

![](file:///C:/Users/kravr/AppData/Local/Temp/msohtmlclip1/01/clip_image004.jpg)